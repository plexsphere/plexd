{
  "feature_id": "PXD-0028",
  "title": "G005: Bridge mode VPN providers and ingress (Tailscale, Netbird, ACME, SNI, IPsec, OpenVPN)",
  "slug": "g005-bridge-mode-vpn-providers-and-ingress",
  "status": "proposed",
  "phase": null,
  "summary": "",
  "description": "**Size:** ðŸ—ï¸ large\n**Category:** backend\n**Priority:** high\n**Source:** Proposed for 'The first implementation (see PLAN.md) is complete'\n\nImplement all bridge mode connectivity providers and ingress:\n\n**Tailscale Integration:** VPN provider for bridge user access. Configure via `auth_key_env: TS_AUTHKEY`. Manage Tailscale daemon lifecycle, advertise routes, handle auth key rotation.\n\n**Netbird Integration:** VPN provider for bridge user access. Configure via `setup_key_env: NB_SETUP_KEY`. Manage Netbird client lifecycle and route advertisement.\n\n**ACME/Let's Encrypt:** Auto-certificate provisioning for public ingress endpoints (`listen: 0.0.0.0:443`). Use `golang.org/x/crypto/acme/autocert` for automatic certificate issuance and renewal.\n\n**SNI-Based Routing:** TLS SNI inspection for routing incoming connections to correct backend services through the bridge.\n\n**IPsec TunnelProvider:** Site-to-site VPN implementation behind existing `TunnelProvider` interface in `internal/bridge/site_to_site.go`.\n\n**OpenVPN TunnelProvider:** Alternative site-to-site VPN implementation behind same `TunnelProvider` interface.\n\n**Rationale:** Bridge mode is a primary use case - connecting users to private networks and linking sites together. Without VPN providers (Tailscale/Netbird), user access doesn't work. Without ACME/SNI, public ingress requires manual certificate management. Without IPsec/OpenVPN, site-to-site tunnels are limited to WireGuard only.\n\n**Affected Areas:**\n- internal/bridge/tailscale.go\n- internal/bridge/netbird.go\n- internal/bridge/acme.go\n- internal/bridge/sni.go\n- internal/bridge/ipsec.go\n- internal/bridge/openvpn.go\n- internal/bridge/site_to_site.go\n- go.mod",
  "stories": [],
  "requirements": [],
  "tasks": [],
  "test_specifications": [],
  "affected_files": [],
  "similar_patterns": [],
  "review_criteria": [],
  "implementation_notes": "",
  "status_history": {
    "proposed": {
      "github_account": "berendt",
      "timestamp": "2026-02-13T20:05:02.793060"
    }
  },
  "elaboration": "\n\nI need to perform a deep gap analysis between the README.md specification and the actual implementation. Let me explore the codebase thoroughly first.Now let me check a few specific details to finalize the gap analysis.Now let me check for the PlexdHook CRD and ConfigMap.Let me check a few more specifics.Now I have comprehensive data. Here's the complete gap analysis:\n\n---\n\n**Size:** ðŸ—ï¸ large\n**Category:** backend | infrastructure\n**Priority:** critical\n\n---\n\n## Summary\n\nFix all identified gaps between the README.md specification and the actual plexd codebase implementation. The codebase has sound architecture at the interface/logic layer but is missing production system-boundary implementations (WireGuard netlink, nftables, SSH server, Ed25519 verification), the entire CLI entry point, 9 of 11 built-in actions, and several integration features (Tailscale/Netbird, ACME/SNI, log file sources, hook file watcher). This task implements all missing components across all 6 phases to bring the codebase to full README parity.\n\n---\n\n## Scope\n\n**Included:**\n- CLI entry point (`cmd/plexd/main.go`) with all 15+ documented subcommands via Cobra\n- Ed25519 `EventVerifier` implementation + nonce replay protection + staleness check\n- Heartbeat service goroutine + 401â†’re-register automation\n- WireGuard kernel/netlink controller via `golang.zx2c4.com/wireguard/wgctrl`\n- nftables firewall backend via `google/nftables`\n- SSH server via `golang.org/x/crypto/ssh` with JWT auth, Ed25519 host keys, idle timeout, max sessions\n- K8s API proxy for secure access tunneling\n- All 9 missing built-in actions (`diagnostics.collect`, `diagnostics.traceroute_peer`, `service.restart`, `service.reload_config`, `service.upgrade`, `health.check`, `mesh.reconnect`, `config.dump`, `logs.snapshot`)\n- Hook file watcher (fsnotify)\n- Local CLI via Unix socket (`plexd actions run`)\n- `PlexdHook` CRD + controller + Job creation\n- Tailscale + Netbird integration for bridge user access\n- ACME/Let's Encrypt auto-certs + SNI-based routing\n- IPsec + OpenVPN protocol support for site-to-site VPN\n- Missing metrics collectors (`agent_stats`, load average, packet loss) + correct default intervals\n- Log file path sources + max line size (16 KiB) + path/severity filtering\n- Unix socket group permissions (`plexd`/`plexd-secrets` groups, `SO_PEERCRED`)\n- Config fixes: Go version alignment, domain consistency, systemd `Restart=always`, WireGuard interface `plexd0`\n- `plexd-config` ConfigMap manifest + `PlexdHook` CRD manifest\n- Makefile (referenced in README but missing)\n\n**Excluded (YAGNI):**\n- Test quality or coverage assessment (separate concern)\n- Performance optimization or benchmarking\n- UI/dashboard for management\n- Windows/macOS support\n\n---\n\n## Gap Analysis Detail\n\n### Phase 1: Core Foundation\n\n| # | Gap | README Spec | Actual Implementation | Severity |\n|---|-----|-------------|----------------------|----------|\n| 1 | **CLI entry point missing** | `cmd/plexd/main.go` with 15+ subcommands (`up`, `join`, `status`, `peers`, `policies`, `logs`, `log-status`, `audit`, `actions`, `actions run`, `hooks list`, `hooks verify`, `hooks reload`, `state`, `state get`, `state report`, `install`, `uninstall`, `deregister`) | No `cmd/` directory exists. No `main.go` anywhere. Binary cannot be built. | **CRITICAL** |\n| 2 | **Ed25519 EventVerifier missing** | All SSE events signed with Ed25519; verifier checks signature, staleness (5 min), nonce uniqueness | Only `NoOpVerifier` exists (`envelope.go:80`). No Ed25519 code. No nonce replay tracking. No staleness check. | **CRITICAL** |\n| 3 | **Heartbeat service goroutine missing** | Background goroutine sending heartbeats at 30s interval; 401â†’re-register flow | `ControlPlane.Heartbeat()` method exists (`endpoints.go:56`) but no service/goroutine that calls it periodically. No 401 re-registration logic. | **HIGH** |\n| 4 | **Unix socket group permissions missing** | `plexd` group for metadata/data/report; `plexd-secrets` group for secrets; `SO_PEERCRED` peer credential checking | Socket created with `0755` dir perms, no group enforcement, no `SO_PEERCRED`, no `plexd-secrets` group distinction. | **HIGH** |\n| 5 | **Makefile missing** | README references `make build`, `make test`, `make test-e2e`, `make lint` | No Makefile exists in project root. CI uses direct `go` commands. | **MEDIUM** |\n\n### Phase 2: Mesh Networking\n\n| # | Gap | README Spec | Actual Implementation | Severity |\n|---|-----|-------------|----------------------|----------|\n| 6 | **WireGuard controller is interface-only** | Production WireGuard via kernel netlink: create/delete interface, set private key, add/remove peers with PSK | `WGController` interface defined (`wireguard/`) with full Manager logic, but no concrete OS implementation. All tests use mock. | **CRITICAL** |\n| 7 | **STUN binding is abstracted** | Real UDP STUN binding requests to `stun.l.google.com:19302`, `stun.cloudflare.com:3478` | `STUNClient` interface defined, `Discoverer` uses it, but no real UDP implementation. | **HIGH** |\n| 8 | **SSH server missing** | `golang.org/x/crypto/ssh` server with JWT auth callback, Ed25519 host key, idle timeout (30m), max sessions (10) | `tunnel/` package implements TCP reverse tunnel forwarding (bidirectional copy), NOT an SSH server. No SSH protocol handling. | **CRITICAL** |\n| 9 | **K8s API proxy missing** | Reverse proxy for Kubernetes API access through secure tunnel | Not implemented. | **HIGH** |\n| 10 | **WireGuard interface name wrong** | README specifies `plexd0` | Default is `wg0` (`config.go:21`: `DefaultInterfaceName = \"wg0\"`) | **MEDIUM** |\n\n### Phase 3: Policy & Security\n\n| # | Gap | README Spec | Actual Implementation | Severity |\n|---|-----|-------------|----------------------|----------|\n| 11 | **nftables backend missing** | Production nftables firewall with diff-based rule updates | `FirewallController` interface defined (`policy/firewall.go`), `Enforcer` generates rules, but no nftables/iptables concrete impl. Enforcer degrades gracefully when nil. | **HIGH** |\n| 12 | **Route controller missing** | IP forwarding, route add/remove, NAT masquerade | `RouteController` interface defined (`bridge/route.go`), no concrete impl. | **HIGH** |\n\n### Phase 4: Bridge Mode\n\n| # | Gap | README Spec | Actual Implementation | Severity |\n|---|-----|-------------|----------------------|----------|\n| 13 | **Tailscale integration missing** | Bridge user access via Tailscale (`auth_key_env: TS_AUTHKEY`) | No Tailscale code anywhere in codebase. | **HIGH** |\n| 14 | **Netbird integration missing** | Bridge user access via Netbird (`setup_key_env: NB_SETUP_KEY`) | No Netbird code anywhere in codebase. | **HIGH** |\n| 15 | **ACME/Let's Encrypt missing** | Auto-cert provisioning for public ingress (`listen: 0.0.0.0:443`) | No ACME, Let's Encrypt, or autocert code. | **HIGH** |\n| 16 | **SNI-based routing missing** | SNI-based routing for public ingress | No SNI routing code. | **HIGH** |\n| 17 | **IPsec protocol missing** | Site-to-site VPN via IPsec | No IPsec code. `site_to_site.go` manages tunnel lifecycle but delegates to `TunnelProvider` interface with no IPsec impl. | **MEDIUM** |\n| 18 | **OpenVPN protocol missing** | Site-to-site VPN via OpenVPN | No OpenVPN code. Same interface gap as IPsec. | **MEDIUM** |\n\n### Phase 5: Observability & Operations\n\n| # | Gap | README Spec | Actual Implementation | Severity |\n|---|-----|-------------|----------------------|----------|\n| 19 | **9 missing built-in actions** | 11 total: `diagnostics.collect`, `diagnostics.ping_peer`, `diagnostics.traceroute_peer`, `service.restart`, `service.reload_config`, `service.upgrade`, `system.info`, `health.check`, `mesh.reconnect`, `config.dump`, `logs.snapshot` | Only 2 implemented: `GatherInfo` (â‰ˆ`system.info`) and `Ping` (â‰ˆ`diagnostics.ping_peer`). 9 missing. | **HIGH** |\n| 20 | **Hook file watcher missing** | fsnotify-based watcher on hook directory for dynamic registration, checksum recalculation on file change, integrity alerts | Discovery is one-time at startup (`discovery.go`). No fsnotify, no runtime reload. | **HIGH** |\n| 21 | **Local CLI via Unix socket missing** | `plexd actions run` connects to local Unix socket for action execution | No Unix socket action server. No CLI client for local action invocation. | **HIGH** |\n| 22 | **Log file path sources missing** | File path reader with glob support (e.g., `/var/log/app/*.log`) | Only `JournaldSource` implemented. No file-based log source. | **HIGH** |\n| 23 | **Log filtering missing** | Path-based filtering, severity filtering, unit filtering | No filter implementation in `logfwd/`. | **MEDIUM** |\n| 24 | **Max line size (16 KiB) not enforced** | Lines truncated at 16384 bytes with `[truncated]` suffix | No truncation logic in log forwarding. | **MEDIUM** |\n| 25 | **`agent_stats` metrics missing** | Goroutine count, heap memory, GC stats, uptime, reconnect count | No agent stats collector. Only System, Latency, Tunnel collectors. | **MEDIUM** |\n| 26 | **Load average metric missing** | Part of `node_resources` group | `SystemCollector` interface exists but no impl; even the interface doesn't mention load average explicitly. | **MEDIUM** |\n| 27 | **Packet loss metric missing** | Part of `tunnel_health` group | No packet loss measurement. `TunnelCollector` collects session counts. | **MEDIUM** |\n| 28 | **Default collect interval wrong** | README: 15s | Code: `DefaultCollectInterval = 30 * time.Second` (`config.go:10`) | **LOW** |\n\n### Phase 6: Platform Support\n\n| # | Gap | README Spec | Actual Implementation | Severity |\n|---|-----|-------------|----------------------|----------|\n| 29 | **`PlexdHook` CRD missing** | CRD definition for `plexdhooks.plexd.plexsphere.com` with jobTemplate, parameters, privileged fields | No PlexdHook CRD YAML in `deploy/kubernetes/crds/`. Only `plexdnodestate-crd.yaml` exists. | **HIGH** |\n| 30 | **PlexdHook controller missing** | K8s controller watching `PlexdHook` resources, creating Jobs for hook execution with node pinning, owner references, service account | No controller code for PlexdHook in `internal/kubernetes/`. Only `crdcontroller.go` for PlexdNodeState. | **HIGH** |\n| 31 | **`plexd-config` ConfigMap manifest missing** | Referenced in DaemonSet as `plexd-config` volume mount | DaemonSet references it (`configMapRef: name: plexd-config`) but no ConfigMap YAML manifest provided. | **MEDIUM** |\n\n### Cross-Cutting Fixes\n\n| # | Gap | README Spec | Actual Implementation | Severity |\n|---|-----|-------------|----------------------|----------|\n| 32 | **Go version in README outdated** | README says \"Go 1.22+\" | `go.mod` says `go 1.24.0`. README prerequisite should match. | **LOW** |\n| 33 | **Domain inconsistency** | README uses `plexsphere.com` for API; install script/docs use `plexsphere.io` | Mixed: `get.plexsphere.com` in README vs `get.plexsphere.io` in install script and docs. | **LOW** |\n| 34 | **Systemd `Restart=` policy** | README implies always-restart for reliability | `Restart=on-failure` in service file. README doesn't specify explicitly, but `Restart=always` is more resilient. | **LOW** |\n| 35 | **WireGuard interface default** | README: `plexd0` | Code: `DefaultInterfaceName = \"wg0\"` | **MEDIUM** |\n| 36 | **SystemReader interface has no impl** | README: CPU, memory, disk, load average, network I/O collection | Interface defined, no concrete implementation. | **HIGH** |\n| 37 | **JournalReader interface has no impl** | README: journald log source | Interface defined, no concrete implementation. | **HIGH** |\n\n---\n\n## Visualization\n\n```mermaid\nflowchart TD\n    subgraph Phase1[\"Phase 1: Core Foundation\"]\n        CLI[\"cmd/plexd/main.go + Cobra 15 subcmds\"]\n        ED25519[\"Ed25519 EventVerifier\"]\n        NONCE[\"Nonce Replay Tracker + Staleness\"]\n        HEARTBEAT[\"Heartbeat Service Goroutine\"]\n        REAUTH[\"401 Re-register Automation\"]\n        SOCKET[\"Unix Socket Group Perms + SO_PEERCRED\"]\n        MAKEFILE[\"Makefile build/test/lint\"]\n    end\n\n    subgraph Phase2[\"Phase 2: Mesh Networking\"]\n        WGKERNEL[\"WireGuard wgctrl Netlink Controller\"]\n        STUN[\"Real UDP STUN Client\"]\n        SSHSRV[\"SSH Server + JWT Auth + Ed25519 Host Key\"]\n        K8SPROXY[\"K8s API Reverse Proxy\"]\n    end\n\n    subgraph Phase3[\"Phase 3: Policy and Security\"]\n        NFT[\"nftables FirewallController Impl\"]\n        ROUTE[\"RouteController Impl\"]\n    end\n\n    subgraph Phase4[\"Phase 4: Bridge Mode\"]\n        TAILSCALE[\"Tailscale VPN Provider\"]\n        NETBIRD[\"Netbird VPN Provider\"]\n        ACME[\"ACME/Lets Encrypt Autocert\"]\n        SNI[\"SNI-Based Routing\"]\n        IPSEC[\"IPsec TunnelProvider\"]\n        OPENVPN[\"OpenVPN TunnelProvider\"]\n    end\n\n    subgraph Phase5[\"Phase 5: Observability and Operations\"]\n        ACTIONS9[\"9 Missing Built-in Actions\"]\n        HOOKWATCH[\"fsnotify Hook File Watcher\"]\n        LOCALCLI[\"Unix Socket Action Server + CLI Client\"]\n        FILELOG[\"File-based LogSource + Glob\"]\n        LOGFILTER[\"Path/Severity Log Filtering\"]\n        LOGTRUNC[\"16 KiB Max Line Truncation\"]\n        AGENTSTATS[\"agent_stats Collector\"]\n        LOADAVG[\"Load Average in SystemReader\"]\n        PKTLOSS[\"Packet Loss in TunnelCollector\"]\n    end\n\n    subgraph Phase6[\"Phase 6: Platform Support\"]\n        PLEXDHOOK_CRD[\"PlexdHook CRD YAML\"]\n        PLEXDHOOK_CTRL[\"PlexdHook Controller + Job Creation\"]\n        CONFIGMAP[\"plexd-config ConfigMap Manifest\"]\n        SYSTEMREADER[\"SystemReader Concrete Impl\"]\n        JOURNALREADER[\"JournalReader Concrete Impl\"]\n    end\n\n    subgraph Fixes[\"Cross-Cutting Fixes\"]\n        WGNAME[\"Default interface wg0 to plexd0\"]\n        INTERVAL[\"DefaultCollectInterval 30s to 15s\"]\n        GOVERSION[\"README Go 1.22+ to 1.24+\"]\n        DOMAIN[\"Domain consistency plexsphere.io\"]\n        SYSTEMD[\"Restart=on-failure to Restart=always\"]\n    end\n\n    style Phase1 fill:#cce5ff,stroke:#004085\n    style Phase2 fill:#cce5ff,stroke:#004085\n    style Phase3 fill:#cce5ff,stroke:#004085\n    style Phase4 fill:#cce5ff,stroke:#004085\n    style Phase5 fill:#cce5ff,stroke:#004085\n    style Phase6 fill:#cce5ff,stroke:#004085\n    style Fixes fill:#fff3cd,stroke:#856404\n```\n\n### Implementation Sequence\n\n```mermaid\nflowchart LR\n    F[\"Cross-Cutting Fixes\"] --> P1[\"Phase 1: Core\"]\n    P1 --> P2[\"Phase 2: Mesh\"]\n    P2 --> P3[\"Phase 3: Policy\"]\n    P3 --> P4[\"Phase 4: Bridge\"]\n    P4 --> P5[\"Phase 5: Observability\"]\n    P5 --> P6[\"Phase 6: Platform\"]\n```\n\n### Dependency Graph (Critical Path)\n\n```mermaid\nflowchart TD\n    CLI --> HEARTBEAT\n    CLI --> LOCALCLI\n    ED25519 --> SSHSRV\n    ED25519 --> NONCE\n    WGKERNEL --> SSHSRV\n    WGKERNEL --> K8SPROXY\n    NFT --> ROUTE\n    ROUTE --> TAILSCALE\n    ROUTE --> NETBIRD\n    ACME --> SNI\n    PLEXDHOOK_CRD --> PLEXDHOOK_CTRL\n    SYSTEMREADER --> AGENTSTATS\n    SYSTEMREADER --> LOADAVG\n    JOURNALREADER --> FILELOG\n```\n\n---\n\n## Key Components (Priority-Ordered)\n\n- **CLI Entry Point** (`cmd/plexd/main.go`): Cobra-based CLI with 15+ subcommands (`up`, `join`, `status`, `peers`, `actions run`, etc.), wiring to existing internal packages\n- **Ed25519 Verifier**: Production `EventVerifier` replacing `NoOpVerifier`, verifying SSE event signatures with control plane public key\n- **Nonce Replay Tracker**: In-memory nonce store with TTL expiry, rejecting duplicate event nonces, 5-min staleness window\n- **Heartbeat Service**: Background goroutine sending periodic heartbeats to control plane, with 401â†’re-register flow\n- **WireGuard Netlink Controller**: Production `WGController` using `wgctrl` library for device/peer configuration, interface name `plexd0`\n- **SystemReader Impl**: Concrete implementation reading `/proc/stat`, `/proc/meminfo`, `/proc/loadavg`, disk stats via `syscall.Statfs`\n- **JournalReader Impl**: Concrete implementation using `sd_journal` or journald socket for live log reading\n- **nftables Backend**: Production `FirewallController` using `google/nftables` library with diff-based rule updates\n- **RouteController Impl**: Production implementation using `netlink` for IP forwarding, routing, NAT masquerade\n- **SSH Server**: `golang.org/x/crypto/ssh` based server with JWT auth callback, Ed25519 host key generation, idle timeout, max session limits\n- **K8s API Proxy**: Reverse proxy for Kubernetes API access through secure tunnel\n- **9 Built-in Actions**: `diagnostics.collect`, `diagnostics.traceroute_peer`, `service.restart`, `service.reload_config`, `service.upgrade`, `health.check`, `mesh.reconnect`, `config.dump`, `logs.snapshot`\n- **Hook File Watcher**: fsnotify-based watcher on hook directory for dynamic hook registration and checksum recalculation\n- **Local Action CLI**: Unix socket server + client for `plexd actions run` local execution\n- **File-based LogSource**: File path reader with glob support, 16 KiB max line truncation, `[truncated]` suffix\n- **Log Filtering**: Path-based, severity-based, unit-based filtering in log forwarding pipeline\n- **PlexdHook CRD + Controller**: CRD YAML manifest, K8s controller watching `PlexdHook` resources, creating Jobs for hook execution\n- **Tailscale/Netbird Integration**: Bridge user access providers implementing VPN provider interface\n- **ACME/SNI**: Let's Encrypt certificate automation + SNI-based routing for public ingress\n- **IPsec/OpenVPN**: Site-to-site VPN protocol implementations behind `TunnelProvider` interface\n- **Metrics Collectors**: `agent_stats` (goroutines, heap, GC), load average in SystemReader, packet loss in TunnelCollector; fix default interval to 15s\n- **Unix Socket Permissions**: Group-based access control with `SO_PEERCRED` peer credential checking (`plexd` / `plexd-secrets` groups)\n- **Config Fixes**: WireGuard default `plexd0`, domain `plexsphere.io`, `Restart=always`, `plexd-config` ConfigMap manifest, Makefile, README Go version\n- **Real STUN Client**: UDP STUN binding implementation for NAT discovery\n\n---\n\n## Quantitative Summary\n\n| Category | Count |\n|----------|-------|\n| **Total gaps identified** | 37 |\n| **CRITICAL severity** | 4 (CLI, Ed25519, WireGuard controller, SSH server) |\n| **HIGH severity** | 17 |\n| **MEDIUM severity** | 11 |\n| **LOW severity** | 5 |\n| **New files to create** | ~25-30 |\n| **Existing files to modify** | ~10-15 |\n| **New dependencies** | ~5 (`cobra`, `wgctrl`, `google/nftables`, `fsnotify`, `vishvananda/netlink`) |"
}